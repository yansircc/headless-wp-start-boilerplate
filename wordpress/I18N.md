# i18n 架构指南

本文档描述项目的多语言（i18n）架构，遵循 **Single Source of Truth (SSOT)** 原则。

---

## SSOT 数据流

```
WordPress Polylang (SSOT - 唯一真实源)
       │
       │ bun sync
       ▼
GraphQL LanguageCodeEnum (自动生成)
       │
       ├──► intlayer.config.ts (自动生成，勿手动修改)
       │
       └──► src/lib/i18n/language.ts (从枚举派生)
                   │
                   ├── toLanguageFilter()  // 用于列表查询
                   └── toLanguageCode()    // 用于翻译查询
                            │
                            └──► 所有服务文件从这里导入
```

**核心原则**：WordPress Polylang 配置决定一切。前端代码自动同步，无需手动维护语言映射。

---

## 添加新语言

### 完整流程

```bash
# 1. 在 WordPress 后台添加语言
#    Languages → Languages → 添加新语言（如 Korean）

# 2. 运行同步命令
bun sync

# 这会自动：
# - 下载更新后的 GraphQL schema（包含新的 LanguageCodeEnum.Ko）
# - 更新 intlayer.config.ts（添加 Locales.KOREAN）
# - src/lib/i18n/language.ts 自动支持新语言（从枚举派生）

# 3. 添加 UI 翻译
vim src/content/common.content.ts
# 为每个翻译键添加新语言版本
```

### 验证同步状态

```bash
# 检查 i18n 配置是否与 GraphQL schema 同步
bun sync:i18n:check
```

---

## 关键文件

| 文件 | 作用 | 可否手动修改 |
|------|------|-------------|
| `src/graphql/_generated/graphql.ts` | 包含 `LanguageCodeEnum` | 不可 |
| `intlayer.config.ts` | Intlayer 语言配置 | 不可（自动生成） |
| `src/lib/i18n/language.ts` | 语言转换工具函数 | 可（但通常不需要） |
| `src/content/*.content.ts` | UI 翻译内容 | 可 |
| `scripts/sync-i18n.ts` | 语言同步脚本 | 可（添加新语言映射时） |

---

## 语言转换函数

### toLanguageFilter(locale)

用于列表查询（获取某语言的所有文章/产品）：

```typescript
import { toLanguageFilter } from "@/lib/i18n/language";

const language = toLanguageFilter("zh"); // → LanguageCodeFilterEnum.Zh

// 在 GraphQL 查询中使用
const result = await graphqlRequest(PostsListDocument, {
  first: 20,
  language, // 过滤指定语言的内容
});
```

### toLanguageCode(locale)

用于翻译查询（获取单个内容的特定语言版本）：

```typescript
import { toLanguageCode } from "@/lib/i18n/language";

const language = toLanguageCode("ja"); // → LanguageCodeEnum.Ja

// 获取特定语言版本
const result = await graphqlRequest(GetPostBySlugDocument, {
  id: "hello-world",
  language, // 获取日语版本
});
return result.post?.translation; // 返回翻译后的内容
```

---

## 服务层模式

所有数据获取服务遵循统一模式：

```typescript
// src/routes/{-$locale}/posts/-services/index.ts
import { toLanguageFilter, toLanguageCode } from "@/lib/i18n/language";

export const getPosts = createServerFn({ method: "GET" })
  .inputValidator((input: { locale?: string }) => input)
  .handler(async ({ data }) => {
    const { locale } = data;
    const cacheKey = cacheKeys.postsList(locale);

    const cached = cache.get(cacheKey);
    if (cached) return cached;

    const language = toLanguageFilter(locale);
    const result = await graphqlRequest(PostsListDocument, { language });

    cache.set(cacheKey, result.posts);
    return result.posts;
  });
```

---

## 扩展语言映射

如果 WordPress 添加了一个 `scripts/sync-i18n.ts` 中未映射的语言，同步脚本会发出警告。

添加映射：

```typescript
// scripts/sync-i18n.ts
const LANGUAGE_TO_INTLAYER: Record<string, string> = {
  En: "Locales.ENGLISH",
  Ja: "Locales.JAPANESE",
  Zh: "Locales.CHINESE",
  Ko: "Locales.KOREAN",
  // 添加新映射
  Vi: "Locales.VIETNAMESE",
};
```

---

## 常见问题

### Q: 为什么 intlayer.config.ts 不能手动修改？

A: 它是从 WordPress Polylang 自动生成的。手动修改会在下次 `bun sync` 时被覆盖。如果需要更改支持的语言，应该在 WordPress Polylang 中操作。

### Q: 添加新语言后前端报错？

A: 确保：
1. 已运行 `bun sync`
2. 检查 `scripts/sync-i18n.ts` 中是否有该语言的映射
3. 在 `src/content/*.content.ts` 中添加了翻译

### Q: 如何只同步 i18n 而不推送 ACF？

A: 使用 `bun sync:i18n`。这只会从现有的 GraphQL schema 更新 `intlayer.config.ts`。
